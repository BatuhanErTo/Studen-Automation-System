@page "/grading"
@attribute [Authorize(Roles = Roles.TeacherRole)]

@using Pusula.Student.Automation.Enums
@using Pusula.Student.Automation.Shared
@using Pusula.Student.Automation.Courses
@using Pusula.Student.Automation.Courses.GradeComponents
@using Pusula.Student.Automation.Teachers
@using Pusula.Student.Automation.Students
@using Pusula.Student.Automation.Enrollments
@using Pusula.Student.Automation.Enrollments.GradeEntries
@using Volo.Abp.AspNetCore.Components.Messages
@using Volo.Abp.AspNetCore.Components.Web.Theming.Layout
@using Volo.Abp.Users

@inherits AutomationComponentBase

@inject ICourseAppService CourseAppService
@inject IEnrollmentAppService EnrollmentAppService
@inject ITeacherAppService TeacherAppService
@inject IUiMessageService UiMessageService
@inject ICurrentUser CurrentUser

<PageHeader Title="Grading" />

<Card>
    <CardBody>
        <Row>
            <Column ColumnSize="ColumnSize.Is6">
                <Field>
                    <FieldLabel>Course</FieldLabel>
                    <SfDropDownList TValue="Guid"
                                    TItem="CourseDto"
                                    Placeholder="Select a course"
                                    DataSource="@TeacherCourses">
                        <DropDownListFieldSettings Value="Id" Text="CourseName"></DropDownListFieldSettings>
                        <DropDownListEvents TValue="Guid" TItem="CourseDto" ValueChange="OnCourseChanged"></DropDownListEvents>
                    </SfDropDownList>
                </Field>
            </Column>
            <Column ColumnSize="ColumnSize.Is6">
                <Field>
                    <FieldLabel>Student</FieldLabel>
                    <SfDropDownList TValue="Guid"
                                    TItem="StudentDto"
                                    Placeholder="Select a student"
                                    DataSource="@EnrolledStudents"
                                    Enabled="@(SelectedCourseIdValue != Guid.Empty)">
                        <DropDownListFieldSettings Value="Id"></DropDownListFieldSettings>
                        <DropDownListTemplates TItem="StudentDto">
                            <ItemTemplate>
                                <span class='name'>@((context as StudentDto).FirstName) @((context as StudentDto).LastName)</span>
                            </ItemTemplate>
                            <ValueTemplate>
                                <span class='name'>@((context as StudentDto).FirstName) @((context as StudentDto).LastName)</span>
                            </ValueTemplate>
                        </DropDownListTemplates>
                        <DropDownListEvents TValue="Guid" TItem="StudentDto" ValueChange="OnStudentChanged"></DropDownListEvents>
                    </SfDropDownList>
                </Field>
            </Column>
        </Row>

        @if (SelectedCourseIdValue != Guid.Empty && SelectedStudentIdValue != Guid.Empty)
        {
            <Divider />
            <Form id="GradeEntryForm">
                <Row>
                    <Column ColumnSize="ColumnSize.Is6">
                        <Field>
                            <FieldLabel>Grade Component</FieldLabel>
                            @if (GradeComponents.Count == 0)
                            {
                                <div class="text-muted">There is no grade component defined for selected course</div>
                            }
                            else
                            {
                                <SfDropDownList TValue="Guid"
                                                TItem="GradeComponentDto"
                                                Placeholder="Select a grade component"
                                                DataSource="@GradeComponents">
                                    <DropDownListFieldSettings Value="Id"></DropDownListFieldSettings>
                                    <DropDownListTemplates TItem="GradeComponentDto">
                                        <ItemTemplate>
                                            @if (context is GradeComponentDto gc)
                                            {
                                                <span class="name">@gc.GradeComponentName (@gc.Weight)</span>
                                            }
                                        </ItemTemplate>

                                        <ValueTemplate>
                                            @if (context is GradeComponentDto gc)
                                            {
                                                <span class="name">@gc.GradeComponentName (@gc.Weight)</span>
                                            }
                                        </ValueTemplate>
                                    </DropDownListTemplates>
                                    <DropDownListEvents TValue="Guid" TItem="GradeComponentDto" ValueChange="OnGradeComponentChanged"></DropDownListEvents>
                                </SfDropDownList>
                            }
                        </Field>
                    </Column>
                    <Column ColumnSize="ColumnSize.Is6">
                        <Field>
                            <FieldLabel>Score</FieldLabel>
                            <NumericEdit TValue="double" @bind-Value="Score" Min="0" Max="100" />
                        </Field>
                    </Column>
                </Row>

                <ModalFooter>
                    <SubmitButton Form="GradeEntryForm"
                                  Clicked="SaveGradeEntryAsync"
                                  Disabled="@(SelectedGradeComponentId == Guid.Empty)">
                        Save Grade
                    </SubmitButton>
                </ModalFooter>
            </Form>
        }
    </CardBody>
</Card>